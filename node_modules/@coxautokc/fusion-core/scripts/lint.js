const CLIEngine = require("eslint").CLIEngine;
const chokidar = require('chokidar');
const chalk = require('chalk');

const config = require('../.eslintrc');

const cli = new CLIEngine(config);
const formatter = cli.getFormatter();

function runLint(){
  const report = cli.executeOnFiles(["./src"]);
  if(report.errorCount === 0 && report.warningCount===0){
    console.log(chalk.green('Linting is clean!'));
  } else {
    console.log(formatter(report.results));
  }
  
}

runLint();

if (process.argv.includes('-w')) {
  const watcher = chokidar.watch('./src', {
    // Ignoring db.json as it is generated. We don't want that to kick off lint again.
    ignored: '**/db.json',
    persistent: true,
    // This setting prevents linting from firing twice when webpack runs.
    awaitWriteFinish: {
      stabilityThreshold: 2000,
      pollInterval: 100
    },
  });
  watcher
    .on('change', path => {
      runLint();
    });
}
